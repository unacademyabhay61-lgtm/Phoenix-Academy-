<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Academy Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0b0c0e; --card: #1c1f26; --primary: #3db2ff; --green: #2ecc71; --danger: #ff4444; }
        body { background: var(--bg); color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding-bottom: 90px; overflow-x: hidden; }
        
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2a2d32; background: #0b0c0e; }
        .logo-text { font-weight: 800; font-size: 20px; color: #fff; }

        #upcoming-box { background: linear-gradient(135deg, #1e2128, #16181c); border: 1px solid #3db2ff44; border-radius: 18px; padding: 15px; margin: 10px 20px; display: none; }
        
        #live-banner { background: linear-gradient(90deg, #ff4444, #b30000); padding: 12px 20px; display: none; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 2px solid rgba(255,255,255,0.2); }
        .live-dot { height: 8px; width: 8px; background: #fff; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        #video-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; }
        .close-video { position: absolute; top: 15px; right: 15px; background: var(--danger); border: none; color: #fff; padding: 10px 20px; border-radius: 12px; z-index: 2005; font-weight: bold; }

        .grid-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px 20px; }
        .icon-box { background: var(--card); height: 55px; width: 55px; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-size: 22px; border: 1px solid #2a2d32; transition: 0.3s; cursor: pointer; }
        .icon-box:active { transform: scale(0.9); background: #2a2d32; }
        .menu-item { text-align: center; }
        .menu-item span { font-size: 10px; color: #888; font-weight: 600; }

        .section-title { padding: 15px 20px 5px; font-size: 16px; font-weight: 800; color: var(--primary); }
        .list-container { padding: 10px 20px; min-height: 50px; }
        .item-card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 12px; border: 1px solid #2a2d32; display: flex; align-items: center; justify-content: space-between; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #16181c; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #222; z-index: 1000; }
        .nav-item { color: #555; text-decoration: none; font-size: 11px; text-align: center; font-weight: bold; }
        .nav-item.active { color: #fff; }

        /* Custom Chat Style */
        #custom-chat-box { position: absolute; bottom: 0; width: 100%; height: 35%; background: #16181c; border-top: 2px solid #333; padding: 15px; box-sizing: border-box; z-index: 2001; }
    </style>
</head>
<body>

    <div id="live-banner" onclick="joinLiveClass()">
        <div><span class="live-dot"></span> <span style="font-weight: 800; font-size: 13px;">LIVE NOW: <span id="live-topic">Topic...</span></span></div>
        <div style="font-size: 10px; background: #000; padding: 5px 12px; border-radius: 10px; font-weight: bold;">JOIN CLASS</div>
    </div>

    <div id="upcoming-box">
        <div style="color: var(--primary); font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px;">üìÖ Next Scheduled Class</div>
        <div id="up-topic" style="font-size: 16px; font-weight: 700;">Topic Name</div>
        <div id="up-time" style="font-size: 12px; color: #888; margin-top: 4px;">Time...</div>
    </div>

    <div id="video-overlay">
        <button class="close-video" onclick="closeLiveClass()">CLOSE ‚úï</button>
        <div id="player-container" style="height: 65%; width: 100%; position: relative; overflow: hidden; background: #000;">
            <div style="position:absolute; top:0; left:0; width:100%; height:60px; z-index:2002;"></div>
            <div style="position:absolute; bottom:0; right:0; width:100px; height:50px; z-index:2002;"></div>
            
            <div id="youtube-embed-area" style="height: 100%; width: 100%;"></div>
        </div>
        
        <div id="custom-chat-box">
            <div style="color:var(--primary); font-size:12px; font-weight:800; margin-bottom:10px;">LIVE CHAT</div>
            <div id="chat-content" style="color:#888; font-size:12px; font-style:italic;">Welcome to Phoenix Academy Live. Stay respectful in chat!</div>
        </div>
    </div>

    <div class="header">
        <div class="logo-text">Phoenix Academy</div>
        <div style="font-size: 11px; color: var(--green); font-weight: 700; border: 1px solid var(--green); padding: 3px 8px; border-radius: 10px;">OFFLINE BATCH</div>
    </div>

    <div class="grid-menu">
        <div class="menu-item" onclick="loadData('notes')"><div class="icon-box">üìö</div><span>Notes</span></div>
        <div class="menu-item" onclick="loadData('polls')"><div class="icon-box">üèÜ</div><span>Tests</span></div>
        <div class="menu-item" onclick="loadData('playlist')"><div class="icon-box">üé¨</div><span>Videos</span></div>
        <div class="menu-item" onclick="alert('Practice sets coming soon!')"><div class="icon-box">‚ö°</div><span>Practice</span></div>
    </div>

    <div class="section-title" id="display-title">Dashboard Overview</div>
    <div id="display-list" class="list-container">
        <p style="text-align:center; color:#444; font-size: 12px;">Select an option from above to view content.</p>
    </div>

    <div class="section-title">üìä My Performance</div>
    <div id="my-records-list" class="list-container" style="padding: 0 15px;"></div>

    <nav class="nav-bar">
        <a href="dashboard.html" class="nav-item active">üè†<br>Home</a>
        <a href="planner.html" class="nav-item">üìÖ<br>Planner</a>
        <a href="profile.html" class="nav-item">üë§<br>Me</a>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA7MHXGSN-ZIybG8sEZiP9kDAwIHRYCfT8",
            authDomain: "phnoenix-coaching.firebaseapp.com",
            projectId: "phnoenix-coaching",
            appId: "1:56032052098:web:43d562162215be0eb3459b"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();

        let currentRoomID = "";
        const studentClass = localStorage.getItem("userClass") || "10th";

        function syncClasses() {
            db.collection("current_live").doc(studentClass).onSnapshot((doc) => {
                if (doc.exists && doc.data().status === "online") {
                    document.getElementById('live-banner').style.display = 'flex';
                    document.getElementById('live-topic').innerText = doc.data().topic;
                    currentRoomID = doc.data().roomID;
                } else {
                    document.getElementById('live-banner').style.display = 'none';
                }
            });

            db.collection("live_classes")
              .where("targetClass", "==", studentClass)
              .orderBy("time", "asc").limit(1)
              .onSnapshot(snap => {
                  if(!snap.empty) {
                      const data = snap.docs[0].data();
                      document.getElementById('upcoming-box').style.display = 'block';
                      document.getElementById('up-topic').innerText = data.topic;
                      const d = new Date(data.time);
                      document.getElementById('up-time').innerText = "‚è∞ " + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                  } else {
                      document.getElementById('upcoming-box').style.display = 'none';
                  }
              });
        }

        async function loadData(type) {
            const listDiv = document.getElementById('display-list');
            const titleDiv = document.getElementById('display-title');
            const titles = { 'notes': 'üìö Academic Notes', 'polls': 'üèÜ Chapter-wise Tests', 'playlist': 'üé¨ Video Lectures' };
            titleDiv.innerText = titles[type] || 'Content';
            listDiv.innerHTML = "<p style='text-align:center; color:#444;'>Syncing data...</p>";
            try {
                const snap = await db.collection(type).where("targetClass", "==", studentClass).get();
                if (snap.empty) {
                    listDiv.innerHTML = "<p style='text-align:center; color:#555; font-size:12px;'>No content available.</p>";
                    return;
                }
                let html = "";
                let uniqueChapters = new Set();
                snap.forEach(doc => {
                    const d = doc.data();
                    if (type === 'polls') {
                        if(!uniqueChapters.has(d.chapter)) {
                            uniqueChapters.add(d.chapter);
                            html += `<div class="item-card" onclick="window.location.href='quiz.html?chapter=${encodeURIComponent(d.chapter)}'">
                                <div><b>${d.chapter}</b><br><small>Click to start test</small></div>
                                <div style="background:var(--primary); color:#000; padding:5px 12px; border-radius:10px; font-weight:bold; font-size:10px;">START</div>
                            </div>`;
                        }
                    } else {
                        html += `<div class="item-card" onclick="window.open('${d.link}', '_blank')">
                            <div><b>${d.title || d.chapter}</b><br><small>Tap to open</small></div>
                            <div style="font-size:18px; color:var(--primary);">‚ûî</div>
                        </div>`;
                    }
                });
                listDiv.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        // --- üöÄ NEW STEALTH JOIN LOGIC ---
        function joinLiveClass() {
            if(!currentRoomID) return;
            document.getElementById('video-overlay').style.display = 'block';
            
            // Masked YouTube Player Implementation
            document.getElementById('youtube-embed-area').innerHTML = `
                <iframe 
                    width="100%" height="100%" 
                    src="https://www.youtube-nocookie.com/embed/${currentRoomID}?autoplay=1&controls=0&modestbranding=1&rel=0&iv_load_policy=3&disablekb=1" 
                    frameborder="0" 
                    allow="autoplay; encrypted-media" 
                    style="pointer-events: none; transform: scale(1.15);">
                </iframe>
            `;
        }

        function closeLiveClass() {
            document.getElementById('video-overlay').style.display = 'none';
            document.getElementById('youtube-embed-area').innerHTML = "";
        }

        function loadMyPerformance() {
            const email = localStorage.getItem("userEmail") || "Anonymous";
            db.collection("test_results").where("student", "==", email).orderBy("timestamp", "desc").limit(5).onSnapshot(snap => {
                const div = document.getElementById('my-records-list');
                div.innerHTML = snap.empty ? "<p style='text-align:center; color:#444; font-size:12px;'>No records found.</p>" : "";
                snap.forEach(doc => {
                    const res = doc.data();
                    div.innerHTML += `<div class="item-card" style="border-left: 4px solid var(--green);">
                        <div><b>${res.subject}</b><br><small>${new Date(res.timestamp?.toDate()).toLocaleDateString() || 'Recent'}</small></div>
                        <div style="background:var(--green); color:#000; padding:5px 12px; border-radius:10px; font-weight:bold;">${res.score}/${res.total}</div>
                    </div>`;
                });
            });
        }

        window.onload = () => { syncClasses(); loadMyPerformance(); };
    </script>
</body>
</html>
